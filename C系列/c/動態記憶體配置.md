---
tags: c
---
# 動態記憶體配置

## 記憶體配置的方式

- 靜態配置：
	- 在編譯時期（compile-time），編譯器便會配置記憶空間給變數
	- 缺點為記憶體使用較無彈性，可能會配置過多或過少
- 動態配置：
	- 在程式執行時期（run-time），才向系統要求記憶空間
	- 可以有效配置記憶體

## 動態記憶體配置

- C 是利用```malloc()``` 函數進行動態記憶體的配置
	- memory allocation

接下來來看 malloc() 的語法
```cpp=
指標變數=(指標變數所指向的型態*) malloc(所需的記憶空間)
```
將malloc()所傳回的位址強制轉換成指標變數所指向的型態
```cpp=
int*ptr;/* 宣告指向整數的指標ptr*/
ptr=(int*) malloc(12); /* 較不好的寫法*/
ptr=(int*) malloc(3*sizeof(int)); /* 較好的寫法*/
```

## 設定與取得記憶體的內容

當我們想要去指定記憶體中的內容時，可以用下訴方法來使用。
- 第k個記憶空間的內容可藉由*(ptr+k-1)來取得

```cpp=
int*ptr;
ptr=(int*) malloc(3*sizeof(int));
*ptr=12;/* 將ptr所指向的第1個記憶空間設值為12 */;
*(ptr+1)=35;/* 將第2個記憶空間設值為35 */
*(ptr+2)=140;/* 將第3個記憶空間設值為140 */
```
![](https://i.imgur.com/U3kpKhl.png)

從上圖來看，可以發現，我們所設定的三個值，成功傳到了記憶體中的三個位置當中。

---
## 歸還記憶空間
有借當然是需要歸還的，當我們有多的記憶體空間時，我們就需要去做一個歸還的動作。
此時可以用```free()```函數，他的語法如下。
```cpp=
free(指標變數); /* 釋放由指標變數所指向的記憶空間*/
```
而當我們沒有去歸還時，會發生以下兩種情形。

- 記憶體洩漏（memory leakage）
	- 沒有用free() 歸還記憶空間，使得記憶體空間無法妥善利用
- 記憶空間分割失敗（segmentation fault）
	- 如果記憶空間已歸還了，卻還嘗試著去使用那塊記憶空間，會讓他一值無法輸入進去，或是產生資料衝突等問題。
---
## 舉例
```cpp=
/* prog14_1, 動態記憶體配置的範例 */
#include<stdio.h>
#include<stdlib.h>
int main(void)
{
   int *ptr,i;
   ptr=(int *) malloc(3*sizeof(int));  /* 配置3個存放整數的空間 */
   
   *ptr=12;			/* 把配置之記憶空間的第1個位置設值為12 */
   *(ptr+1)=35;		/* 把第2個位置設值為35 */
   *(ptr+2)=140;		/* 把第3個位置設值為140 */
   
   for(i=0;i<3;i++)
      printf("*ptr+%d=%d\n",i,*(ptr+i));   /* 印出存放的值 */
    
   free(ptr);           /* 釋放由ptr所指向的記憶空間 */

   system("pause");
   return 0;
}

>>>*ptr+0=12
>>>*ptr+1=35
>>>*ptr+2=140
```